<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í—¬ìŠ¤ì¼€ì–´ ì‹ë‹¨ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Malgun Gothic', 'sans-serif'],
                    },
                    colors: {
                        primary: '#006064',
                        secondary: '#E0F7FA',
                        accent: '#FF9800',
                        danger: '#D32F2F',
                        success: '#00796B',
                    }
                }
            }
        }
    </script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (ì„ íƒ ì‚¬í•­) */
        .report-content::-webkit-scrollbar {
            width: 8px;
        }
        .report-content::-webkit-scrollbar-thumb {
            background-color: #00bcd4;
            border-radius: 10px;
        }
        .report-content::-webkit-scrollbar-track {
            background-color: #e0f7fa;
        }
        .page-container {
            display: none;
        }
        .active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header (ìƒë‹¨ ë°”) -->
    <header class="bg-primary shadow-lg p-3 flex justify-between items-center fixed top-0 w-full z-10">
        <h1 class="text-xl font-bold text-white tracking-wider">AI ì‹ë‹¨ ë¶„ì„</h1>
        <div id="point-display" class="bg-amber-500 text-white font-bold px-3 py-1 rounded-full shadow-md text-sm">
            ğŸ’° ëˆ„ì  í¬ì¸íŠ¸: 0ì 
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="flex-grow p-4 mt-16 max-w-lg mx-auto w-full">
        <!-- ---------------------------------------------------- -->
        <!-- 1. ì§ˆë³‘ ì„ íƒ í™”ë©´ (Disease Selection) -->
        <!-- ---------------------------------------------------- -->
        <div id="disease-selection-view" class="page-container active bg-white p-6 rounded-xl shadow-2xl border border-primary/20">
            <h2 class="text-2xl font-extrabold text-primary mb-6 text-center">1. ì‚¬ìš©ì ì§ˆë³‘ ì •ë³´ ì„ íƒ</h2>
            
            <p id="selected-disease-display" class="text-center text-xl font-bold text-danger mb-8 border-b-2 pb-2">ì—†ìŒ</p>

            <div id="disease-buttons-container" class="grid grid-cols-2 gap-4">
                <!-- Buttons will be generated by JavaScript -->
            </div>
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- 2. ìŒì‹ ì‚¬ì§„ ì…ë ¥ ì‹œë®¬ë ˆì´ì…˜ (Photo Attachment) -->
        <!-- ---------------------------------------------------- -->
        <div id="food-input-view" class="page-container bg-white p-6 rounded-xl shadow-2xl border border-primary/20">
            <h2 class="text-2xl font-extrabold text-primary mb-4 text-center">2. ìŒì‹ ì‚¬ì§„ ì¸ì‹ ì‹œë®¬ë ˆì´ì…˜</h2>
            
            <div class="mb-4 p-3 bg-secondary rounded-lg border border-primary/30">
                <p class="text-sm text-gray-700">í˜„ì¬ ì„ íƒëœ ì§ˆë³‘: <span id="current-disease" class="font-bold text-danger"></span></p>
                <p class="text-sm text-gray-700">AI ì¸ì‹ ê°€ëŠ¥ ìŒì‹: <span class="font-bold text-success">ìƒëŸ¬ë“œ, ì–‘ë…ì¹˜í‚¨</span></p>
            </div>

            <!-- AI ì¸ì‹ ì‹œë®¬ë ˆì´ì…˜ ì…ë ¥ -->
            <div class="mb-6">
                <label for="food-input" class="block text-md font-semibold text-gray-700 mb-2">
                    ğŸ½ï¸ ìŒì‹ ì´ë¦„ ì…ë ¥ (AI ì¸ì‹ ì‹œë®¬ë ˆì´ì…˜)
                </label>
                <input type="text" id="food-input" placeholder="ì˜ˆ: ìƒëŸ¬ë“œ ë˜ëŠ” ì–‘ë…ì¹˜í‚¨" class="w-full p-3 border-2 border-primary/50 rounded-lg focus:ring-accent focus:border-accent text-lg" value="ì–‘ë…ì¹˜í‚¨">
            </div>

            <!-- ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ë° ë²„íŠ¼ -->
            <div class="mb-8 p-4 bg-gray-100 rounded-lg">
                <p id="ai-recognition-result" class="text-center text-lg font-bold text-gray-600">AI ì¸ì‹ ê²°ê³¼: [ì…ë ¥ ëŒ€ê¸°ì¤‘]</p>
            </div>

            <div class="flex flex-col space-y-3">
                <button onclick="analyzeFood()" class="w-full bg-accent hover:bg-amber-600 text-white font-extrabold py-3 rounded-xl shadow-lg transition duration-200">
                    â¡ï¸ ë¶„ì„ ë³´ê³ ì„œ í™•ì¸í•˜ê¸° (AI ë¶„ì„ ì‹¤í–‰)
                </button>
                <button onclick="showFrame('DiseaseSelectionFrame')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-xl transition duration-200">
                    ğŸ”™ ì§ˆë³‘ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- 3. ë¶„ì„ ê²°ê³¼ í™”ë©´ (Result Display) -->
        <!-- ---------------------------------------------------- -->
        <div id="result-view" class="page-container bg-white p-6 rounded-xl shadow-2xl border border-primary/20">
            <h2 class="text-2xl font-extrabold text-primary mb-4 text-center">ğŸŒŸ ì‹ë‹¨ ë¶„ì„ ìµœì¢… ë³´ê³ ì„œ ğŸŒŸ</h2>
            
            <p id="analysis-summary" class="text-center text-lg font-bold text-success mb-6 p-2 bg-secondary rounded-lg border border-success/30">ë¶„ì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”</p>

            <div id="report-output" class="bg-gray-50 border border-gray-300 rounded-lg p-4 overflow-y-auto h-[400px] report-content text-sm font-mono whitespace-pre-wrap">
                ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.
            </div>

            <button onclick="showFrame('PhotoAttachmentFrame')" class="w-full mt-6 bg-accent/80 hover:bg-accent text-white font-bold py-3 rounded-xl shadow-lg transition duration-200">
                ğŸ”™ ë‹¤ë¥¸ ìŒì‹ ë¶„ì„í•˜ê¸°
            </button>
        </div>

    </main>

    <!-- JavaScript Logic -->
    <script>
        // ====================================================================
        // 1. í•µì‹¬ ë°ì´í„° ì •ì˜ (íŒŒì´ì¬ íŒŒì¼ì˜ ë°ì´í„° ì´ì‹)
        // ====================================================================

        const DAILY_VALUES = {
            "kcal": 2000, "ë‚˜íŠ¸ë¥¨": 2300, "íƒ„ìˆ˜í™”ë¬¼": 275, "ë‹¹ë¶„": 50,
            "ì§€ë°©": 78, "í¬í™”ì§€ë°©": 20, "ì½œë ˆìŠ¤í…Œë¡¤": 300, "ë‹¨ë°±ì§ˆ": 50,
        };

        const FOOD_DB = {
            "ìƒëŸ¬ë“œ": {
                "kcal": 250, "ë‚˜íŠ¸ë¥¨": 150, "íƒ„ìˆ˜í™”ë¬¼": 15, "ë‹¹ë¶„": 5,
                "ì§€ë°©": 15, "í¬í™”ì§€ë°©": 3, "íŠ¸ëœìŠ¤ì§€ë°©": 0, "ì½œë ˆìŠ¤í…Œë¡¤": 10, "ë‹¨ë°±ì§ˆ": 10
            },
            "ì–‘ë…ì¹˜í‚¨": {
                "kcal": 1200, "ë‚˜íŠ¸ë¥¨": 900, "íƒ„ìˆ˜í™”ë¬¼": 80, "ë‹¹ë¶„": 35,
                "ì§€ë°©": 85, "í¬í™”ì§€ë°©": 25, "íŠ¸ëœìŠ¤ì§€ë°©": 0.5, "ì½œë ˆìŠ¤í…Œë¡¤": 150, "ë‹¨ë°±ì§ˆ": 70
            },
        };

        // (ì œí•œê°’, ìœ„í—˜ ê°€ì¤‘ì¹˜) íŠœí”Œì„ JS ë°°ì—´ë¡œ ë³€í™˜
        const DISEASE_RESTRICTIONS_WITH_WEIGHTS = {
            "ê³ í˜ˆì••": {"ë‚˜íŠ¸ë¥¨": [500, 1.5], "ì§€ë°©": [30, 0.8]},
            "ê³ ì§€í˜ˆì¦": {"ì½œë ˆìŠ¤í…Œë¡¤": [100, 1.5], "í¬í™”ì§€ë°©": [15, 1.3]},
            "ë¹„ë§Œ": {"kcal": [600, 1.4], "ì§€ë°©": [40, 1.2]},
            "ì œ1í˜• ë‹¹ë‡¨ë³‘": {"íƒ„ìˆ˜í™”ë¬¼": [60, 1.4], "ë‹¹ë¶„": [15, 1.2]},
            "ì œ2í˜• ë‹¹ë‡¨ë³‘": {"kcal": [550, 1.1], "ì§€ë°©": [35, 1.1], "íƒ„ìˆ˜í™”ë¬¼": [70, 1.0], "ë‹¹ë¶„": [25, 1.0]},
        };

        // ====================================================================
        // 2. í•µì‹¬ ë¡œì§ í´ë˜ìŠ¤: í—¬ìŠ¤ì¼€ì–´ ë¶„ì„ê¸° (íŒŒì´ì¬ í´ë˜ìŠ¤ ì´ì‹)
        // ====================================================================

        class HealthAnalyzer {
            constructor(userDisease) {
                this.userDisease = userDisease.trim();
                this.points = 0;
                this.feedbackEmoji = "ğŸ˜ ì£¼ì˜ í•„ìš”";
                this.recommendation = "íŠ¹ë³„í•œ ê¶Œì¥ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
                this.foodTypeClassification = "ì¼ë°˜ ìŒì‹";
            }

            analyzeMeal(foodName) {
                const mealData = FOOD_DB[foodName];
                if (!mealData) return null;

                this.foodTypeClassification = this._classifyFoodType(foodName);
                const score = this._calculateDiseaseScore(mealData);
                this._determineFeedbackAndPoints(score, foodName, mealData);
                const detailedNutrition = this._getDetailedNutritionAnalysis(mealData);

                return {
                    foodName, disease: this.userDisease, score,
                    emoji: this.feedbackEmoji, points: this.points, recommendation: this.recommendation,
                    foodTypeClassification: this.foodTypeClassification, detailedNutrition,
                };
            }

            _getDetailedNutritionAnalysis(mealData) {
                const analysis = {};
                const nutrientsInfo = [
                    ["kcal", "ì—´ëŸ‰ (Calories)", "kcal", true], ["ë‚˜íŠ¸ë¥¨", "ë‚˜íŠ¸ë¥¨ (Sodium)", "mg", true],
                    ["íƒ„ìˆ˜í™”ë¬¼", "íƒ„ìˆ˜í™”ë¬¼ (Carbs)", "g", true], ["ë‹¹ë¶„", "â†³ ë‹¹ë¥˜ (Sugars)", "g", true],
                    ["ì§€ë°©", "ì§€ë°© (Fat)", "g", true], ["í¬í™”ì§€ë°©", "â†³ í¬í™”ì§€ë°© (Sat. Fat)", "g", true],
                    ["íŠ¸ëœìŠ¤ì§€ë°©", "â†³ íŠ¸ëœìŠ¤ì§€ë°© (Trans Fat)", "g", false], ["ì½œë ˆìŠ¤í…Œë¡¤", "ì½œë ˆìŠ¤í…Œë¡¤ (Cholesterol)", "mg", true],
                    ["ë‹¨ë°±ì§ˆ", "ë‹¨ë°±ì§ˆ (Protein)", "g", true],
                ];

                for (const [key, displayName, unit, calculateDv] of nutrientsInfo) {
                    const amount = mealData[key] || 0;
                    let dvPercent = "-";
                    if (calculateDv && DAILY_VALUES[key] && DAILY_VALUES[key] > 0) {
                        dvPercent = `${Math.round((amount / DAILY_VALUES[key]) * 100)}%`;
                    }
                    analysis[key] = { displayName, amount: `${Math.round(amount * 10) / 10} ${unit}`, dvPercent };
                }
                return analysis;
            }

            _classifyFoodType(foodName) {
                if (foodName.includes("ì¹˜í‚¨")) return "âš ï¸ ê³ ìœ„í—˜êµ° (ê³ ì¹¼ë¡œë¦¬/ê³ ì§€ë°©)";
                if (foodName.includes("ìƒëŸ¬ë“œ")) return "âœ… ì €ìœ„í—˜êµ° (ì €ì¹¼ë¡œë¦¬/ì±„ì†Œ)";
                return "ì¼ë°˜ ìŒì‹";
            }

            _calculateDiseaseScore(mealData) {
                let baseScore = 100;
                let penaltyFactor = 0;
                const restrictionsWithWeights = DISEASE_RESTRICTIONS_WITH_WEIGHTS[this.userDisease] || {};
                
                if (Object.keys(restrictionsWithWeights).length > 0) {
                    for (const nutrient in restrictionsWithWeights) {
                        const [limit, weight] = restrictionsWithWeights[nutrient];
                        const actualValue = mealData[nutrient] || 0;
                        if (actualValue > limit) {
                            const exceedRatio = actualValue / limit;
                            const basePenalty = (exceedRatio - 1) * 20;
                            const penalty = basePenalty * weight;
                            penaltyFactor += penalty;
                        }
                    }
                } else {
                    if ((mealData["ë‚˜íŠ¸ë¥¨"] || 0) > 1000 || (mealData["kcal"] || 0) > 1000) {
                        penaltyFactor += 25;
                    }
                }
                
                return Math.max(0, parseInt(baseScore - penaltyFactor));
            }

            _determineFeedbackAndPoints(score, currentFood, mealData) {
                this.recommendation = this._recommendSimilarHealthyFood(currentFood, mealData);
                
                if (score >= 90) {
                    this.feedbackEmoji = "ğŸ˜ƒ í›Œë¥­í•©ë‹ˆë‹¤! ì´ ì‹ë‹¨ì„ ìœ ì§€í•˜ì„¸ìš”!";
                    this.points = 10;
                } else if (score >= 70) {
                    this.feedbackEmoji = "ğŸ™‚ ì–‘í˜¸í•©ë‹ˆë‹¤. ë‹¤ìŒ ì‹ì‚¬ ì‹œ ë‚˜íŠ¸ë¥¨/ë‹¹ë¶„ë§Œ ì¤„ì—¬ë³´ì„¸ìš”.";
                    this.points = 5;
                } else if (score >= 50) {
                    this.feedbackEmoji = "ğŸ˜ ì£¼ì˜ í•„ìš”. ê²½ê³  êµ¬ê°„ì…ë‹ˆë‹¤. ëŒ€ì²´ ì‹í’ˆì„ ê²€í† í•˜ì„¸ìš”.";
                    this.points = 2;
                } else {
                    this.points = 0;
                    // ì§ˆë³‘ë³„ êµ¬ì²´ì ì¸ ê²½ê³  ë©”ì‹œì§€ ì„¤ì • (íŒŒì´ì¬ íŒŒì¼ì˜ ë¡œì§ ì´ì‹)
                    if (this.userDisease === "ê³ í˜ˆì••") {
                        this.feedbackEmoji = "ğŸš¨ ë‚˜íŠ¸ë¥¨ê³¼ í¬í™”ì§€ë°© ê²½ë³´! í˜ˆê´€ ê±´ê°•ì— ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    } else if (this.userDisease === "ê³ ì§€í˜ˆì¦") {
                        this.feedbackEmoji = "ğŸš¨ ì½œë ˆìŠ¤í…Œë¡¤ ë° í¬í™”ì§€ë°© ê²½ë³´! í˜ˆê´€ ê±´ê°•ì— ì ì‹ í˜¸ì…ë‹ˆë‹¤. ì¦‰ì‹œ ì‹ë‹¨ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.";
                    } else if (this.userDisease === "ì œ1í˜• ë‹¹ë‡¨ë³‘") {
                        this.feedbackEmoji = "ğŸ©¸ ì¸ìŠë¦° ê´€ë¦¬ ë¹„ìƒ! íƒ„ìˆ˜í™”ë¬¼/ë‹¹ë¶„ì´ ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    } else if (this.userDisease === "ì œ2í˜• ë‹¹ë‡¨ë³‘") {
                        this.feedbackEmoji = "ğŸ©¸ ëŒ€ì‚¬ ìœ„ê¸° ê²½ê³ ! ê³¼ë„í•œ ì¹¼ë¡œë¦¬ì™€ ì§€ë°©ì€ í˜ˆë‹¹ ìŠ¤íŒŒì´í¬ì˜ ì›ì¸ì…ë‹ˆë‹¤.";
                    } else if (this.userDisease === "ë¹„ë§Œ") {
                        this.feedbackEmoji = "ğŸƒâ€â™‚ï¸ ì¹¼ë¡œë¦¬ ì´ˆê³¼ ê²½ë³´! ì´ ìŒì‹ì€ ë‹¤ì´ì–´íŠ¸ì˜ 'ë ˆë“œì¹´ë“œ'ì…ë‹ˆë‹¤.";
                    } else {
                        this.feedbackEmoji = "ğŸ˜¢ ìœ„í—˜! ë‹¤ìŒ ì‹ì‚¬ëŠ” ë°˜ë“œì‹œ ì¶”ì²œ ë©”ë‰´ë¡œ ëŒ€ì²´í•˜ì„¸ìš”!";
                    }
                }
            }
                
            _recommendSimilarHealthyFood(currentFood, mealData) {
                const disease = this.userDisease;
                
                if (currentFood === "ì–‘ë…ì¹˜í‚¨") {
                    const reasons = [];
                    if (disease.includes("ê³ í˜ˆì••")) {
                        const sodium = mealData["ë‚˜íŠ¸ë¥¨"] || 0;
                        reasons.push(`ë‚˜íŠ¸ë¥¨(${sodium}mg)ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.`);
                        return `ğŸ— ëŒ€ì²´ ê¶Œê³ : ${reasons.join(', ')} ì–‘ë…ì„ ë‹¦ì•„ë‚´ê±°ë‚˜ ì €ì—¼ ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œë¡œ ëŒ€ì²´í•˜ì„¸ìš”.`;
                    }
                    
                    if (disease.includes("ë‹¹ë‡¨ë³‘") || disease.includes("ë¹„ë§Œ")) {
                        const sugar = mealData["ë‹¹ë¶„"] || 0;
                        const fat = mealData["ì§€ë°©"] || 0;
                        reasons.push(`ë‹¹ë¶„(${sugar}g)ê³¼ ì§€ë°©(${fat}g) í•¨ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤.`);
                        return `ğŸ— ëŒ€ì²´ ê¶Œê³ : ${reasons.join(', ')} ì–‘ë… ì—†ëŠ” êµ¬ìš´ ë‹­ê°€ìŠ´ì‚´ì„ ë“œì„¸ìš”.`;
                    }
                    
                    if (disease.includes("ê³ ì§€í˜ˆì¦")) {
                        const cholesterol = mealData["ì½œë ˆìŠ¤í…Œë¡¤"] || 0;
                        const satFat = mealData["í¬í™”ì§€ë°©"] || 0;
                        reasons.push(`ì½œë ˆìŠ¤í…Œë¡¤(${cholesterol}mg)ê³¼ í¬í™”ì§€ë°©(${satFat}g)ì´ ê¸°ì¤€ì¹˜ë¥¼ í¬ê²Œ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                        return `ğŸ— ëŒ€ì²´ ê¶Œê³ : ${reasons.join(', ')} íŠ€ê¹€ ëŒ€ì‹  êµ¬ìš´ ë‹­ê°€ìŠ´ì‚´ì„ ì„­ì·¨í•˜ê³ , ì§€ë°©ì´ ë§ì€ ê»ì§ˆì€ ì œê±°í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`;
                    }
                }

                if (currentFood === "ìƒëŸ¬ë“œ") {
                    const sodium = mealData["ë‚˜íŠ¸ë¥¨"] || 0;
                    if (sodium > 200) {
                        return `âš ï¸ ìƒëŸ¬ë“œ ë“œë ˆì‹± ì–‘ì„ ì¤„ì—¬ ë‚˜íŠ¸ë¥¨(${sodium}mg) ì„­ì·¨ë¥¼ ì¡°ì ˆí•´ì£¼ì„¸ìš”.`;
                    }
                    return "íŠ¹ë³„í•œ ëŒ€ì²´ ê¶Œê³  ì‚¬í•­ì€ ì—†ìŠµë‹ˆë‹¤. í›Œë¥­í•©ë‹ˆë‹¤!";
                }
                    
                return "ì–‘ ì¡°ì ˆì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
            }
        }


        // ====================================================================
        // 3. UI ë° ìƒíƒœ ê´€ë¦¬
        // ====================================================================

        let totalPoints = 0;
        let selectedDisease = 'ì—†ìŒ';
        let aiRecognizedFood = '';

        const diseaseNames = ["ê³ í˜ˆì••", "ê³ ì§€í˜ˆì¦", "ì œ1í˜• ë‹¹ë‡¨ë³‘", "ì œ2í˜• ë‹¹ë‡¨ë³‘", "ë¹„ë§Œ", "ì—†ìŒ"];
        
        /** í˜ì´ì§€ ì „í™˜ */
        function showFrame(frameId) {
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            const frame = document.getElementById(frameId.toLowerCase().replace('frame', '-view'));
            if (frame) {
                frame.classList.add('active');
                if (frameId === 'PhotoAttachmentFrame') {
                    // PhotoAttachmentFrameìœ¼ë¡œ ì´ë™ ì‹œ í˜„ì¬ ì„ íƒëœ ì§ˆë³‘ í‘œì‹œ ì—…ë°ì´íŠ¸
                    document.getElementById('current-disease').textContent = selectedDisease;
                } else if (frameId === 'ResultDisplayFrame') {
                    // ResultDisplayFrameìœ¼ë¡œ ì´ë™ ì‹œ ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
                    const foodName = aiRecognizedFood;
                    const disease = selectedDisease;
                    document.getElementById('analysis-summary').textContent = foodName && FOOD_DB[foodName] 
                        ? `ë¶„ì„ ëŒ€ê¸°: ${foodName} / ì§ˆë³‘: ${disease}` 
                        : `ë¶„ì„ ë°ì´í„° ì—†ìŒ. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ì„¸ìš”.`;
                    document.getElementById('report-output').textContent = "ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.\n\në¶„ì„ í›„ ì´ ì˜ì—­ì— ìƒì„¸ ë³´ê³ ì„œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.";
                }
            }
        }

        /** ì§ˆë³‘ ì„ íƒ í•¸ë“¤ëŸ¬ */
        function selectDisease(disease) {
            selectedDisease = disease;
            document.getElementById('selected-disease-display').textContent = disease;
            // ì•Œë¦¼ ëŒ€ì‹  ì‹œê°ì  í”¼ë“œë°±ê³¼ í•¨ê»˜ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
            setTimeout(() => {
                showFrame('PhotoAttachmentFrame');
            }, 300);
        }

        /** ìŒì‹ ë¶„ì„ ì‹¤í–‰ */
        function analyzeFood() {
            const foodInput = document.getElementById('food-input').value.trim();
            aiRecognizedFood = foodInput;
            
            const recognitionLabel = document.getElementById('ai-recognition-result');

            if (!aiRecognizedFood || !FOOD_DB[aiRecognizedFood]) {
                recognitionLabel.className = 'text-center text-lg font-bold text-danger';
                if (!aiRecognizedFood) {
                    recognitionLabel.textContent = 'AI ì¸ì‹ ê²°ê³¼: [ìŒì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”]';
                } else {
                    recognitionLabel.textContent = `AI ì¸ì‹ ê²°ê³¼: ${aiRecognizedFood} (DB ë¯¸í™•ì¸)`;
                }
                return;
            }

            recognitionLabel.textContent = `AI ì¸ì‹ ê²°ê³¼: ${aiRecognizedFood} (ì¸ì‹ ì™„ë£Œ)`;
            recognitionLabel.className = 'text-center text-lg font-bold text-success';
            
            showFrame('ResultDisplayFrame');

            // ë°”ë¡œ ë¶„ì„ ì‹œì‘ ë¡œì§ í˜¸ì¶œ
            _analyzeAndDisplay();
        }

        /** ë¶„ì„ ì‹¤í–‰ ë° ê²°ê³¼ í‘œì‹œ (íŒŒì´ì¬ _analyze_and_display í•¨ìˆ˜ ì´ì‹) */
        function _analyzeAndDisplay() {
            const disease = selectedDisease;
            const foodName = aiRecognizedFood;

            if (!foodName || !FOOD_DB[foodName]) {
                // ê²½ê³  ëŒ€ì‹  ì‚¬ìš©ì ì •ì˜ UIë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ì§€ë§Œ, í˜„ì¬ ì½”ë“œ êµ¬ì¡°ìƒ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
                // alert("ë¶„ì„ ì˜¤ë¥˜: DBì— ì—†ëŠ” ìŒì‹ì´ê±°ë‚˜ ìŒì‹ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); 
                console.error("ë¶„ì„ ì˜¤ë¥˜: DBì— ì—†ëŠ” ìŒì‹ì´ê±°ë‚˜ ìŒì‹ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const analyzer = new HealthAnalyzer(disease);
            const analysisResult = analyzer.analyzeMeal(foodName);

            if (!analysisResult) {
                // alert(`ë¶„ì„ ë¶ˆê°€: '${foodName}'ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                console.error(`ë¶„ì„ ë¶ˆê°€: '${foodName}'ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            const pointsEarned = analysisResult.points;
            totalPoints += pointsEarned;
            updatePointsDisplay();

            _displayReportContent(analysisResult);
            // ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì œê³µ
            console.log(`ë¶„ì„ ì™„ë£Œ: ${pointsEarned}ì  íšë“!`);
        }

        /** ë³´ê³ ì„œ ë‚´ìš© í‘œì‹œ (íŒŒì´ì¬ _display_report_content í•¨ìˆ˜ ì´ì‹) */
        function _displayReportContent(res) {
            document.getElementById('analysis-summary').textContent = `ë¶„ì„ ì™„ë£Œ: ${res.foodName} / ì§ˆë³‘: ${res.disease}`;
            document.getElementById('analysis-summary').className = 'text-center text-lg font-bold text-success mb-6 p-2 bg-green-100 rounded-lg border border-success/30';
            
            let output = `
[ AI ìŒì‹ ë¶„ë¥˜ ê²°ê³¼ ]
 > ${res.foodTypeClassification}

[ ì‚¬ìš©ì ì •ë³´ ]
 > í™˜ì ì§ˆë³‘: ${res.disease !== 'ì—†ìŒ' ? res.disease : 'í•´ë‹¹ ì—†ìŒ'}
 > AI ì¸ì‹ ìŒì‹: ${res.foodName}

[ AI ì •ë°€ ë¶„ì„ ê²°ê³¼ ]
 > â­ï¸ ì í•©ì„± ì ìˆ˜: ${res.score}ì  (ê°€ì¤‘ì¹˜ ë°˜ì˜)
 > ğŸ™‚ ê°ì„± í”¼ë“œë°±: ${res.emoji}
 > ğŸ’° íšë“ í¬ì¸íŠ¸: +${res.points}ì 

==================================================
 ğŸ“ ì˜ì–‘ ì •ë³´ ìƒì„¸ ë¶„ì„ (1ì¸ë¶„ ê¸°ì¤€)
==================================================
${'ì˜ì–‘ì„±ë¶„'.padEnd(16)}|${'í•¨ëŸ‰'.padStart(18)}|${'ë¹„ìœ¨(%DV)'.padStart(10)}
--------------------------------------------------
`;
            const dtNutr = res.detailedNutrition;
            const nutrientOrder = ["kcal", "ë‚˜íŠ¸ë¥¨", "íƒ„ìˆ˜í™”ë¬¼", "ë‹¹ë¶„", "ì§€ë°©", "í¬í™”ì§€ë°©", "íŠ¸ëœìŠ¤ì§€ë°©", "ì½œë ˆìŠ¤í…Œë¡¤", "ë‹¨ë°±ì§ˆ"];

            for (const key of nutrientOrder) {
                if (dtNutr[key]) {
                    const item = dtNutr[key];
                    const name = item.displayName.padEnd(15);
                    const amount = item.amount.padStart(18);
                    const dv = item.dvPercent.padStart(10);
                    output += `${name}|${amount}|${dv}\n`;
                }
            }
            
            output += "--------------------------------------------------\n\n";
            output += `[ ë§ì¶¤í˜• ì œì•ˆ ]
 > ${res.recommendation}
`;
            
            document.getElementById('report-output').textContent = output;
        }


        /** í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ */
        function updatePointsDisplay() {
            document.getElementById('point-display').textContent = `ğŸ’° ëˆ„ì  í¬ì¸íŠ¸: ${totalPoints}ì `;
        }

        /** ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • */
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('disease-buttons-container');
            diseaseNames.forEach(disease => {
                const button = document.createElement('button');
                button.textContent = disease;
                button.className = 'bg-blue-100 hover:bg-blue-200 text-primary font-bold py-3 rounded-lg shadow transition duration-150';
                button.onclick = () => selectDisease(disease);
                container.appendChild(button);
            });
            
            // ì´ˆê¸° í˜ì´ì§€ í‘œì‹œ
            showFrame('DiseaseSelectionFrame');
        });

    </script>
</body>
</html>
